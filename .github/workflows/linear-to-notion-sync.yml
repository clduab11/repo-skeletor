# Linear to Notion Sync
# Syncs Linear issue updates to corresponding Notion database entries
# Triggered via webhook from Linear or manual dispatch

name: Linear to Notion Sync

on:
  repository_dispatch:
    types: [linear-webhook]
  workflow_dispatch:
    inputs:
      issue_id:
        description: "Linear Issue ID (e.g., PAR-123)"
        required: true
        type: string
      sync_type:
        description: "Type of sync operation"
        required: true
        type: choice
        options:
          - full
          - status-only
          - metadata-only

env:
  LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
  NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
  NOTION_DATABASE_ID: ${{ secrets.NOTION_SPEC_DATABASE_ID }}
  LINEAR_TEAM_KEY: "PAR"

jobs:
  sync:
    name: Sync Linear to Notion
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install @linear/sdk @notionhq/client

      - name: Extract Issue Data
        id: extract
        run: |
          # Determine issue ID from webhook or input
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            ISSUE_ID="${{ github.event.client_payload.issue_id }}"
            ACTION="${{ github.event.client_payload.action }}"
          else
            ISSUE_ID="${{ github.event.inputs.issue_id }}"
            ACTION="${{ github.event.inputs.sync_type }}"
          fi
          echo "issue_id=$ISSUE_ID" >> $GITHUB_OUTPUT
          echo "action=$ACTION" >> $GITHUB_OUTPUT

      - name: Fetch Linear Issue
        id: linear
        uses: actions/github-script@v7
        with:
          script: |
            const { LinearClient } = require('@linear/sdk');
            const linear = new LinearClient({ apiKey: process.env.LINEAR_API_KEY });

            const issueId = '${{ steps.extract.outputs.issue_id }}';

            // Fetch issue by identifier (e.g., PAR-123)
            const issue = await linear.issue(issueId);
            if (!issue) {
              core.setFailed(`Issue ${issueId} not found`);
              return;
            }

            // Get related data
            const state = await issue.state;
            const assignee = await issue.assignee;
            const project = await issue.project;
            const labels = await issue.labels();

            const issueData = {
              id: issue.id,
              identifier: issue.identifier,
              title: issue.title,
              description: issue.description || '',
              priority: issue.priority,
              estimate: issue.estimate,
              dueDate: issue.dueDate,
              state: state?.name || 'Unknown',
              stateType: state?.type || 'unstarted',
              assignee: assignee?.name || 'Unassigned',
              assigneeEmail: assignee?.email || '',
              project: project?.name || '',
              labels: labels.nodes.map(l => l.name),
              url: issue.url,
              createdAt: issue.createdAt,
              updatedAt: issue.updatedAt
            };

            core.setOutput('issue_data', JSON.stringify(issueData));
            console.log('Fetched issue:', issueData.identifier, issueData.title);

      - name: Sync to Notion
        uses: actions/github-script@v7
        with:
          script: |
            const { Client } = require('@notionhq/client');
            const notion = new Client({ auth: process.env.NOTION_API_KEY });

            const issueData = JSON.parse('${{ steps.linear.outputs.issue_data }}'.replace(/'/g, "\\'"));
            const databaseId = process.env.NOTION_DATABASE_ID;

            // Map Linear state to Notion status
            const stateMap = {
              'unstarted': 'Not Started',
              'started': 'In Progress',
              'completed': 'Done',
              'canceled': 'Canceled',
              'backlog': 'Backlog'
            };

            // Map Linear priority to Notion
            const priorityMap = {
              0: 'No Priority',
              1: 'Urgent',
              2: 'High',
              3: 'Medium',
              4: 'Low'
            };

            // Search for existing page by Linear ID
            const searchResponse = await notion.databases.query({
              database_id: databaseId,
              filter: {
                property: 'Linear ID',
                rich_text: {
                  equals: issueData.identifier
                }
              }
            });

            const properties = {
              'Name': {
                title: [{ text: { content: issueData.title } }]
              },
              'Linear ID': {
                rich_text: [{ text: { content: issueData.identifier } }]
              },
              'Status': {
                select: { name: stateMap[issueData.stateType] || 'Not Started' }
              },
              'Priority': {
                select: { name: priorityMap[issueData.priority] || 'No Priority' }
              },
              'Assignee': {
                rich_text: [{ text: { content: issueData.assignee } }]
              },
              'Linear URL': {
                url: issueData.url
              },
              'Last Synced': {
                date: { start: new Date().toISOString() }
              }
            };

            // Add optional properties
            if (issueData.dueDate) {
              properties['Due Date'] = { date: { start: issueData.dueDate } };
            }
            if (issueData.estimate) {
              properties['Estimate'] = { number: issueData.estimate };
            }
            if (issueData.project) {
              properties['Project'] = {
                rich_text: [{ text: { content: issueData.project } }]
              };
            }

            if (searchResponse.results.length > 0) {
              // Update existing page
              const pageId = searchResponse.results[0].id;
              await notion.pages.update({
                page_id: pageId,
                properties
              });
              console.log(`Updated Notion page for ${issueData.identifier}`);
            } else {
              // Create new page
              await notion.pages.create({
                parent: { database_id: databaseId },
                properties,
                children: issueData.description ? [
                  {
                    object: 'block',
                    type: 'paragraph',
                    paragraph: {
                      rich_text: [{ text: { content: issueData.description.substring(0, 2000) } }]
                    }
                  }
                ] : []
              });
              console.log(`Created Notion page for ${issueData.identifier}`);
            }

      - name: Post Sync Summary
        if: always()
        run: |
          echo "## Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **Issue:** ${{ steps.extract.outputs.issue_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Action:** ${{ steps.extract.outputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
